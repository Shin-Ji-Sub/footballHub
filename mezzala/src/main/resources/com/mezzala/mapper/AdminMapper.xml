<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mezzala.mapper.AdminMapper">
    <resultMap id="UserResultMap" type="com.mezzala.dto.UserDto">
        <id property="userId" column="u_user_id"/>
        <result property="nickname" column="u_nickname"/>
        <result property="socialMethod" column="u_social_method"/>
        <result property="joinDate" column="u_join_date"/>
        <result property="roleId" column="u_role_id"/>
        <result property="state" column="u_state"/>
        <result property="writeBoardCount" column="writeBoardCount"/>
        <result property="writeCommentCount" column="writeCommentCount"/>
        <result property="reportCount" column="reportCount"/>
        <result property="userScore" column="userScore"/>
        <!-- 1:1 관계 user_role -->
        <association property="userRole" javaType="com.mezzala.dto.UserRoleDto">
            <id property="roleId" column="ur_role_id" />
            <result property="roleName" column="ur_role_name" />
            <result property="roleKorName" column="ur_role_kor_name" />
        </association>
    </resultMap>
    <resultMap id="BoardLargeCategoryResultMap" type="com.mezzala.dto.BoardLargeCategoryDto">
        <id property="largeCategoryId" column="large_category_id" />
        <result property="largeCategoryName" column="large_category_name" />
        <collection property="smallCategories" ofType="com.mezzala.dto.BoardSmallCategoryDto">
            <id property="smallCategoryIndex" column="small_category_index" />
            <result property="largeCategoryId" column="large_category_id" />
            <result property="smallCategoryName" column="small_category_name"/>
        </collection>
    </resultMap>
    <!-- <id> → <result> → <association> → <collection> 순서를 지켜야함!-->
    <resultMap id="BoardResultMap" type="com.mezzala.dto.BoardDto">
        <id property="boardId" column="board_id" />
        <result property="subject" column="subject" />
        <result property="content" column="content" />
        <result property="regDate" column="reg_date" />
        <result property="visitCount" column="visit_count" />
        <result property="recommendationCount" column="recommendationCount" />
        <result property="reportCount" column="reportCount" />
        <result property="commentCount" column="commentCount" />
        <result property="boardState" column="board_state" />
        <!-- 1:1 관계 user -->
        <association property="user" javaType="com.mezzala.dto.UserDto">
            <id property="userId" column="user_id" />
            <result property="nickname" column="nickname" />
            <result property="socialMethod" column="social_method" />
            <result property="joinDate" column="join_date" />
            <result property="roleId" column="role_id" />
            <result property="state" column="state" />
        </association>
        <!-- 1:1 관계 board_large_category -->
        <association property="largeCategory" javaType="com.mezzala.dto.BoardLargeCategoryDto">
            <id property="largeCategoryId" column="large_category_id" />
            <result property="largeCategoryName" column="large_category_name" />
        </association>
        <!-- 1:1 관계 board_small_category -->
        <association property="smallCategory" javaType="com.mezzala.dto.BoardSmallCategoryDto">
            <id property="smallCategoryIndex" column="small_category_index" />
            <result property="smallCategoryName" column="small_category_name" />
        </association>
        <!-- 1:N 관계 board_attach -->
        <collection property="boardAttaches" ofType="com.mezzala.dto.BoardAttachDto">
            <id property="attachId" column="attach_id" />
            <result property="userFileName" column="user_file_name" />
            <result property="savedFileName" column="saved_file_name" />
        </collection>
        <!-- 1:N 관계 user_action -->
        <collection property="userActions" ofType="com.mezzala.dto.UserActionDto">
            <id property="actionId" column="action_id"/>
            <result property="actionCategory" column="action_category"/>
            <result property="userId" column="user_id"/>
            <result property="boardId" column="board_id"/>
        </collection>
    </resultMap>
    <resultMap id="CommentResultMap" type="com.mezzala.dto.CommentDto">
        <id property="commentId" column="c_comment_id"/>
        <result property="parentId" column="c_parent_id"/>
        <result property="regDate" column="c_reg_date"/>
        <result property="content" column="c_content"/>
        <result property="recommendationCount" column="c1_recommendation_count"/>
        <result property="reportCount" column="c_reportCount" />
        <result property="commentState" column="c_comment_state"/>
        <result property="userId" column="c_user_id"/>
        <result property="boardId" column="c_board_id"/>
        <association property="board" javaType="com.mezzala.dto.BoardDto">
            <id property="boardId" column="b_board_id" />
            <result property="subject" column="b_subject" />
            <result property="content" column="b_content" />
            <result property="regDate" column="b_reg_date" />
            <result property="visitCount" column="b_visit_count" />
            <result property="boardState" column="b_board_state" />
            <result property="largeCategoryId" column="b_large_category_id"/>
            <result property="smallCategoryIndex" column="b_small_category_index"/>
            <!-- 1:1 관계 board_large_category -->
            <association property="largeCategory" javaType="com.mezzala.dto.BoardLargeCategoryDto">
                <id property="largeCategoryId" column="lc_large_category_id" />
                <result property="largeCategoryName" column="lc_large_category_name" />
            </association>
            <!-- 1:1 관계 board_small_category -->
            <association property="smallCategory" javaType="com.mezzala.dto.BoardSmallCategoryDto">
                <id property="smallCategoryIndex" column="sc_small_category_index" />
                <result property="smallCategoryName" column="sc_small_category_name" />
            </association>
        </association>
        <association property="user" javaType="com.mezzala.dto.UserDto">
            <id property="userId" column="u_user_id" />
            <result property="nickname" column="u_nickname" />
            <result property="socialMethod" column="u_social_method" />
            <result property="joinDate" column="u_join_date" />
            <result property="roleId" column="u_role_id" />
            <result property="state" column="u_state" />
        </association>
    </resultMap>
    <resultMap id="CommentActionResultMap" type="com.mezzala.dto.CommentActionDto">
        <id property="actionId" column="ca_action_id"/>
        <result property="userId" column="ca_user_id"/>
        <result property="commentId" column="ca_comment_id"/>
        <association property="comment" javaType="com.mezzala.dto.CommentDto">
            <id property="commentId" column="c_comment_id"/>
            <result property="parentId" column="c_parent_id"/>
            <result property="regDate" column="c_reg_date"/>
            <result property="content" column="c_content"/>
            <result property="commentState" column="c_comment_state"/>
            <result property="userId" column="c_user_id"/>
            <result property="boardId" column="c_board_id"/>
        </association>
    </resultMap>
    <resultMap id="ScheduleResultMap" type="com.mezzala.dto.ScheduleDto">
        <id property="scheduleId" column="s_schedule_id"/>
        <result property="scheduleDate" column="s_schedule_date"/>
        <result property="competitionId" column="s_competition_id"/>
        <result property="roundId" column="s_round_id"/>
        <result property="homeTeamId" column="s_home_team_id"/>
        <result property="awayTeamId" column="s_away_team_id"/>
        <association property="competition" javaType="com.mezzala.dto.CompetitionDto">
            <id property="competitionId" column="c_competition_id"/>
            <result property="competitionName" column="c_competition_name"/>
            <result property="competitionCategory" column="c_competition_category"/>
        </association>
        <association property="competitionRound" javaType="com.mezzala.dto.CompetitionRoundDto">
            <id property="roundId" column="cr_round_id"/>
            <result property="roundName" column="cr_round_name"/>
        </association>
        <association property="homeTeam" javaType="com.mezzala.dto.TeamDto">
            <id property="teamId" column="ht_team_id"/>
            <result property="teamName" column="ht_team_name"/>
            <result property="logoAddress" column="ht_logo_address"/>
        </association>
        <association property="awayTeam" javaType="com.mezzala.dto.TeamDto">
            <id property="teamId" column="at_team_id"/>
            <result property="teamName" column="at_team_name"/>
            <result property="logoAddress" column="at_logo_address"/>
        </association>
    </resultMap>
    <resultMap id="RankingResultMap" type="com.mezzala.dto.RankingDto">
        <id property="rankingId" column="r_ranking_id"/>
        <result property="season" column="r_season"/>
        <result property="competitionId" column="r_competition_id"/>
        <result property="teamId" column="r_team_id"/>
        <result property="matchCount" column="r_match_count"/>
        <result property="point" column="r_point"/>
        <result property="win" column="r_win"/>
        <result property="draw" column="r_draw"/>
        <result property="lose" column="r_lose"/>
        <result property="scorePoint" column="r_score_point"/>
        <result property="losePoint" column="r_lose_point"/>
        <association property="competition" javaType="com.mezzala.dto.CompetitionDto">
            <id property="competitionId" column="c_competition_id"/>
            <result property="competitionName" column="c_competition_name"/>
            <result property="competitionCategory" column="c_competition_category"/>
            <result property="championsLeagueFrom" column="c_champions_league_from"/>
            <result property="championsLeagueTo" column="c_champions_league_to"/>
            <result property="otherLeagueFrom" column="c_other_league_from"/>
            <result property="otherLeagueTo" column="c_other_league_to"/>
        </association>
        <association property="team" javaType="com.mezzala.dto.TeamDto">
            <id property="teamId" column="t_team_id"/>
            <result property="teamName" column="t_team_name"/>
            <result property="logoAddress" column="t_logo_address"/>
        </association>
    </resultMap>

    <insert id="insertBoard" parameterType="BoardDto" useGeneratedKeys="true" keyProperty="boardId">
        INSERT INTO
            board (
                subject,
                content,
                user_id,
                large_category_id
            )
        VALUES (
                #{subject},
                #{content},
                #{userId},
                #{largeCategoryId}
            )
    </insert>

    <insert id="insertBoardAttach" parameterType="hashmap">
        INSERT INTO
            board_attach (
                user_file_name,
                saved_file_name,
                board_id
            )
        VALUES
            <foreach collection="imageFiles" item="file" separator=",">
                (
                    #{file.userFileName},
                    #{file.savedFileName},
                    #{boardId}
                )
            </foreach>
    </insert>

    <select id="selectAllNoticeBoardCount" parameterType="hashmap" resultType="int">
        SELECT
            COUNT(*)
        FROM
            board b
        WHERE
            b.board_state = #{state}
        AND
            b.large_category_id = 3
        <choose>
            <when test="searchValue.length != null and searchValue != ''">
                AND
                    b.subject LIKE CONCAT('%', #{searchValue}, '%')
            </when>
        </choose>
    </select>

    <select id="selectNoticeBoardWithPaging" parameterType="hashmap" resultMap="BoardResultMap">
        SELECT
            b.board_id,
            b.subject,
            b.content,
            b.reg_date,
            b.visit_count,
            COALESCE(COUNT(DISTINCT ua.action_id), 0) AS recommendationCount,
            COALESCE(COUNT(DISTINCT c.comment_id), 0) AS commentCount,
            b.board_state,
            u.user_id,
            u.nickname,
            u.social_method,
            u.join_date,
            u.role_id,
            u.state,
            MAX(ba.attach_id) AS attach_id,
            MAX(ba.user_file_name) AS user_file_name,
            MAX(ba.saved_file_name) AS saved_file_name,
            lc.large_category_id,
            lc.large_category_name,
            sc.small_category_index,
            sc.small_category_name
        FROM
            board b
        LEFT JOIN
            user_action ua
        ON
            b.board_id = ua.board_id
        AND
            ua.action_category = "like"
        LEFT JOIN
            comment c
        ON
            b.board_id = c.board_id
        LEFT JOIN
            user u
        ON
            b.user_id = u.user_id
        LEFT JOIN
            board_attach ba
        ON
            b.board_id = ba.board_id
        LEFT JOIN
            board_large_category lc
        ON
            b.large_category_id = lc.large_category_id
        LEFT JOIN
            board_small_category sc
        ON
            b.small_category_index = sc.small_category_index
        WHERE
            b.board_state = #{state}
        AND
            b.large_category_id = 3
        <choose>
            <when test="searchValue.length != null and searchValue != ''">
                AND
                    b.subject LIKE CONCAT('%', #{searchValue}, '%')
            </when>
        </choose>
        GROUP BY
            b.board_id
        ORDER BY
            b.reg_date DESC
        LIMIT
            <choose>
                <when test="state == true">
                    5
                </when>
                <when test="state == false">
                    10
                </when>
            </choose>
        OFFSET
            #{start}
    </select>

    <update id="updateBoardState" parameterType="hashmap">
        UPDATE
            board
        SET
            board_state = #{state}
        WHERE
            board_id = #{boardId}
    </update>

    <update id="updateVisitedBoard" parameterType="int">
        UPDATE
            board
        SET
            visit_count = visit_count + 1
        WHERE
            board_id = #{boardId}
    </update>

    <select id="selectNoticeBoardWithBoardId" parameterType="int" resultMap="BoardResultMap">
        SELECT
            b.board_id,
            b.subject,
            b.content,
            b.reg_date,
            b.visit_count,
            b.board_state,
            u.user_id,
            u.nickname,
            u.social_method,
            u.join_date,
            u.role_id,
            u.state,
            ba.attach_id,
            ba.user_file_name,
            ba.saved_file_name,
            lc.large_category_id,
            lc.large_category_name,
            ua.action_id,
            ua.action_category,
            ua.user_id,
            ua.board_id
        FROM
            board b
        LEFT JOIN
            user_action ua
        ON
            b.board_id = ua.board_id
        AND
            ua.action_category = "like"
        LEFT JOIN
            user u
        ON
            b.user_id = u.user_id
        LEFT JOIN
            board_attach ba
        ON
            b.board_id = ba.board_id
        LEFT JOIN
            board_large_category lc
        ON
            b.large_category_id = lc.large_category_id
        WHERE
            b.board_id = #{boardId}
    </select>

    <update id="updateBoardsState" parameterType="list">
        UPDATE
            board
        SET
            board_state = true
        WHERE
            large_category_id = 3
        AND
            board_id
        IN
            <foreach collection="list" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
    </update>

    <select id="selectCategories" resultMap="BoardLargeCategoryResultMap">
        SELECT
            large.large_category_id,
            large.large_category_name,
            small.small_category_index,
            small.large_category_id,
            small.small_category_name
        FROM
            board_large_category large
        LEFT JOIN
            board_small_category small
        ON
            large.large_category_id = small.large_category_id
        ORDER BY
            small.small_category_index;
    </select>

    <select id="selectAllBoardCount" parameterType="hashmap" resultType="int">
        SELECT
            COUNT(*)
        FROM
            board b
        LEFT JOIN
            report r
        ON
            b.board_id = r.reported_content_id
        AND
            r.report_category = "board"
        LEFT JOIN
            board_large_category lc
        ON
            b.large_category_id = lc.large_category_id
        LEFT JOIN
            board_small_category sc
        ON
            b.small_category_index = sc.small_category_index
        WHERE
            b.large_category_id != 3
        <choose>
            <when test="totalSelectValue == '신고된글'">
                AND
                b.board_id = r.reported_content_id
            </when>
            <when test="totalSelectValue != 'all' and smallSelectValue == 'all'">
                AND
                    b.large_category_id = #{totalSelectValue}
            </when>
            <when test="totalSelectValue != 'all' and smallSelectValue != 'all'">
                AND
                    b.large_category_id = #{totalSelectValue}
                AND
                    b.small_category_index = #{smallSelectValue}
            </when>
        </choose>
        <choose>
            <when test="searchValue.length != null and searchValue != ''">
                AND
                    b.subject LIKE CONCAT('%', #{searchValue}, '%')
            </when>
        </choose>
    </select>

    <select id="selectBoardWithPaging" parameterType="hashmap" resultMap="BoardResultMap">
        SELECT
            b.board_id,
            b.subject,
            b.content,
            b.reg_date,
            b.visit_count,
            COALESCE(COUNT(DISTINCT ua.action_id), 0) AS recommendationCount,
            COALESCE(COUNT(DISTINCT c.comment_id), 0) AS commentCount,
            b.board_state,
            u.user_id,
            u.nickname,
            u.social_method,
            u.join_date,
            u.role_id,
            u.state,
            MAX(ba.attach_id) AS attach_id,
            MAX(ba.user_file_name) AS user_file_name,
            MAX(ba.saved_file_name) AS saved_file_name,
            lc.large_category_id,
            lc.large_category_name,
            sc.small_category_index,
            sc.small_category_name,
            COALESCE(COUNT(DISTINCT r.report_id), 0) AS reportCount
        FROM
            board b
        LEFT JOIN
            report r
        ON
            b.board_id = r.reported_content_id
        AND
            r.report_category = "board"
        LEFT JOIN
            user_action ua
        ON
            b.board_id = ua.board_id
        AND
            ua.action_category = "like"
        LEFT JOIN
            comment c
        ON
            b.board_id = c.board_id
        LEFT JOIN
            user u
        ON
            b.user_id = u.user_id
        LEFT JOIN
            board_attach ba
        ON
            b.board_id = ba.board_id
        LEFT JOIN
            board_large_category lc
        ON
            b.large_category_id = lc.large_category_id
        LEFT JOIN
            board_small_category sc
        ON
            b.small_category_index = sc.small_category_index
        WHERE
            b.board_state = true
        AND
            b.large_category_id != 3
        <choose>
            <when test="totalSelectValue == '신고된글'">
                AND
                b.board_id = r.reported_content_id
            </when>
            <when test="totalSelectValue != 'all' and smallSelectValue == 'all'">
                AND
                    b.large_category_id = #{totalSelectValue}
            </when>
            <when test="totalSelectValue != 'all' and smallSelectValue != 'all'">
                AND
                    b.large_category_id = #{totalSelectValue}
                AND
                    b.small_category_index = #{smallSelectValue}
            </when>
        </choose>
        <choose>
            <when test="searchValue.length != null and searchValue != ''">
                AND
                    b.subject LIKE CONCAT('%', #{searchValue}, '%')
            </when>
        </choose>
        GROUP BY
            b.board_id
        ORDER BY
            <choose>
                <when test="totalSelectValue == '신고된글' and sortValue == 'latest'">
                    COALESCE(COUNT(DISTINCT r.report_id), 0) DESC,
                    b.reg_date DESC
                </when>
                <when test="totalSelectValue == '신고된글' and sortValue == 'best'">
                    COALESCE(COUNT(DISTINCT r.report_id), 0) DESC,
                    b.visit_count + (COUNT(ua.board_id) * 2) DESC,
                    b.reg_date DESC
                </when>
                <when test="sortValue == 'latest' and totalSelectValue != '신고된글'">
                    b.reg_date DESC
                </when>
                <when test="sortValue == 'best' and totalSelectValue != '신고된글'">
                    b.visit_count + (COUNT(ua.board_id) * 2) DESC,
                    b.reg_date DESC
                </when>
            </choose>
        LIMIT
            10
        OFFSET
            #{start}
    </select>

    <select id="selectBoardWithBoardId" parameterType="int" resultMap="BoardResultMap">
        SELECT
            b.board_id,
            b.subject,
            b.content,
            b.reg_date,
            b.visit_count,
            b.board_state,
            u.user_id,
            u.nickname,
            u.social_method,
            u.join_date,
            u.role_id,
            u.state,
            ba.attach_id,
            ba.user_file_name,
            ba.saved_file_name,
            lc.large_category_id,
            lc.large_category_name,
            sc.small_category_index,
            sc.small_category_name,
            ua.action_id,
            ua.action_category,
            ua.user_id,
            ua.board_id
        FROM
            board b
        LEFT JOIN
            user_action ua
        ON
            b.board_id = ua.board_id
        AND
            ua.action_category = "like"
        LEFT JOIN
            user u
        ON
            b.user_id = u.user_id
        LEFT JOIN
            board_attach ba
        ON
            b.board_id = ba.board_id
        LEFT JOIN
            board_large_category lc
        ON
            b.large_category_id = lc.large_category_id
        LEFT JOIN
            board_small_category sc
        ON
            b.small_category_index = sc.small_category_index
        WHERE
            b.board_id = #{boardId}
    </select>

    <select id="selectAllReportBoardCount" parameterType="int" resultType="int">
        SELECT
            COUNT(*)
        FROM
            board b
        LEFT JOIN
            report r
        ON
            b.board_id = r.reported_content_id
        AND
            r.report_category = "board"
        LEFT JOIN
            board_large_category lc
        ON
            b.large_category_id = lc.large_category_id
        LEFT JOIN
            board_small_category sc
        ON
            b.small_category_index = sc.small_category_index
        WHERE
            b.large_category_id != 3
        AND
            b.board_id = r.reported_content_id
        <choose>
            <when test="searchValue.length != null and searchValue != ''">
                AND
                    b.subject LIKE CONCAT('%', #{searchValue}, '%')
            </when>
        </choose>
    </select>

    <select id="selectReportBoardWithPaging" parameterType="hashmap" resultMap="BoardResultMap">
        SELECT
            b.board_id,
            b.subject,
            b.content,
            b.reg_date,
            b.visit_count,
            COALESCE(COUNT(DISTINCT ua.action_id), 0) AS recommendationCount,
            COALESCE(COUNT(DISTINCT c.comment_id), 0) AS commentCount,
            b.board_state,
            u.user_id,
            u.nickname,
            u.social_method,
            u.join_date,
            u.role_id,
            u.state,
            MAX(ba.attach_id) AS attach_id,
            MAX(ba.user_file_name) AS user_file_name,
            MAX(ba.saved_file_name) AS saved_file_name,
            lc.large_category_id,
            lc.large_category_name,
            sc.small_category_index,
            sc.small_category_name,
            COALESCE(COUNT(DISTINCT r.report_id), 0) AS reportCount
        FROM
            board b
        LEFT JOIN
            report r
        ON
            b.board_id = r.reported_content_id
        AND
            r.report_category = "board"
        LEFT JOIN
            user_action ua
        ON
            b.board_id = ua.board_id
        AND
            ua.action_category = "like"
        LEFT JOIN
            comment c
        ON
            b.board_id = c.board_id
        LEFT JOIN
            user u
        ON
            b.user_id = u.user_id
        LEFT JOIN
            board_attach ba
        ON
            b.board_id = ba.board_id
        LEFT JOIN
            board_large_category lc
        ON
            b.large_category_id = lc.large_category_id
        LEFT JOIN
            board_small_category sc
        ON
            b.small_category_index = sc.small_category_index
        WHERE
            b.board_state = true
        AND
            b.large_category_id != 3
        AND
            b.board_id = r.reported_content_id
        <choose>
            <when test="searchValue.length != null and searchValue != ''">
                AND
                    b.subject LIKE CONCAT('%', #{searchValue}, '%')
            </when>
        </choose>
        GROUP BY
            b.board_id
        ORDER BY
            <choose>
                <when test="sortValue == 'reportOrder'">
                    COALESCE(COUNT(DISTINCT r.report_id), 0) DESC,
                    b.reg_date DESC
                </when>
                <when test="sortValue == 'latest'">
                    b.reg_date DESC
                </when>
            </choose>
        LIMIT
            10
        OFFSET
            #{start}
    </select>

    <select id="selectAllReportBoardCommentCount" parameterType="String" resultType="int">
        SELECT
            COUNT(DISTINCT c.comment_id)
        FROM
            comment c
        LEFT JOIN
            report r
        ON
            c.comment_id = r.reported_content_id
        AND
            r.report_category = "comment"
        WHERE
            c.comment_state = true
        AND
            c.comment_id = r.reported_content_id
        <choose>
            <when test="searchValue.length != null and searchValue != ''">
                AND
                    c.content LIKE CONCAT('%', #{searchValue}, '%')
            </when>
        </choose>
    </select>

    <select id="selectReportBoardCommentWithPaging" parameterType="hashmap" resultMap="CommentResultMap">
        SELECT
            c.comment_id AS c_comment_id,
            c.parent_id AS c_parent_id,
            c.reg_date AS c_reg_date,
            c.content AS c_content,
            c.comment_state AS c_comment_state,
            c.user_id AS c_user_id,
            c.board_id AS c_board_id,

            b.board_id AS b_board_id,
            b.subject AS b_subject,
            b.content AS b_content,
            b.reg_date AS b_reg_date,
            b.visit_count AS b_visit_count,
            b.board_state AS b_board_state,
            b.user_id AS b_user_id,
            b.large_category_id AS b_large_category_id,
            b.small_category_index AS b_small_category_index,

            lc.large_category_id AS lc_large_category_id,
            lc.large_category_name AS lc_large_category_name,

            sc.small_category_index AS sc_small_category_index,
            sc.small_category_name AS sc_small_category_name,

            COALESCE(COUNT(DISTINCT r.report_id), 0) AS c_reportCount,

            u.user_id AS u_user_id,
            u.nickname AS u_nickname,
            u.social_method AS u_social_method,
            u.join_date AS u_join_date,
            u.role_id AS u_role_id,
            u.state AS u_state
        FROM
            comment c
        LEFT JOIN
            user u
        ON
            c.user_id = u.user_id
        LEFT JOIN
            report r
        ON
            c.comment_id = r.reported_content_id
        AND
            r.report_category = "comment"
        LEFT JOIN
            board b
        ON
            c.board_id = b.board_id
        LEFT JOIN
            board_large_category lc
        ON
            b.large_category_id = lc.large_category_id
        LEFT JOIN
            board_small_category sc
        ON
            b.small_category_index = sc.small_category_index
        WHERE
            c.comment_state = true
        AND
            c.comment_id = r.reported_content_id
        <choose>
            <when test="searchValue.length != null and searchValue != ''">
                AND
                    c.content LIKE CONCAT('%', #{searchValue}, '%')
            </when>
        </choose>
        GROUP BY
            c.comment_id
        ORDER BY
            <choose>
                <when test="sortValue == 'reportOrder'">
                    COALESCE(COUNT(DISTINCT r.report_id), 0) DESC,
                    c.reg_date DESC
                </when>
                <when test="sortValue == 'latest'">
                    c.reg_date DESC
                </when>
            </choose>
        LIMIT
            10
        OFFSET
            #{start}
    </select>

    <select id="selectAllLargeCategoryCount" resultType="int">
        SELECT
            COUNT(*)
        FROM
            board_large_category
    </select>

    <select id="selectAllSmallCategoryCount" parameterType="int" resultType="int">
        SELECT
            COUNT(*)
        FROM
            board_small_category sc
        LEFT JOIN
            board_large_category lc
        ON
            sc.large_category_id = lc.large_category_id
        WHERE
            sc.large_category_id = #{largeCategoryValue}
    </select>

    <select id="selectLargeCategory" parameterType="int" resultType="BoardLargeCategoryDto">
        SELECT
            large_category_id AS largeCategoryId,
            large_category_name AS largeCategoryName
        FROM
            board_large_category
        ORDER BY
            large_category_id DESC
        LIMIT
            10
        OFFSET
            #{start}
    </select>

    <select id="selectAllLargeCategory" resultType="BoardLargeCategoryDto">
        SELECT
            large_category_id AS largeCategoryId,
            large_category_name AS largeCategoryName
        FROM
            board_large_category
        ORDER BY
            large_category_id ASC
    </select>

    <select id="selectSmallCategory" parameterType="hashmap" resultType="BoardSmallCategoryDto">
        SELECT
            sc.small_category_index AS smallCategoryIndex,
            sc.large_category_id AS largeCategoryId,
            sc.small_category_name AS smallCategoryName
        FROM
            board_small_category sc
        LEFT JOIN
            board_large_category lc
        ON
            sc.large_category_id = lc.large_category_id
        WHERE
            sc.large_category_id = #{largeCategoryValue}
        ORDER BY
            small_category_index DESC
        LIMIT
            10
        OFFSET
            #{start}
    </select>

    <insert id="insertLargeCategory" parameterType="String">
        INSERT INTO
            board_large_category (
                large_category_name
            )
        VALUES (
                #{categoryValue}
            )
    </insert>

    <insert id="insertSmallCategory" parameterType="hashmap">
        INSERT INTO
            board_small_category (
                large_category_id,
                small_category_name
            )
        VALUES (
                #{largeCategoryValue},
                #{categoryValue}
            )
    </insert>

    <update id="updateLargeCategory" parameterType="hashmap">
        UPDATE
            board_large_category
        SET
            large_category_name = #{categoryName}
        WHERE
            large_category_id = #{categoryId}
    </update>

    <update id="updateSmallCategory" parameterType="hashmap">
        UPDATE
            board_small_category
        SET
            small_category_name = #{categoryName}
        WHERE
            small_category_index = #{categoryId}
    </update>

    <delete id="deleteLargeCategory" parameterType="int">
        DELETE FROM
            board_large_category
        WHERE
            large_category_id = #{categoryId}
    </delete>

    <delete id="deleteSmallCategory" parameterType="int">
        DELETE FROM
            board_small_category
        WHERE
            small_category_index = #{categoryId}
    </delete>

    <select id="selectAllUserRole" resultType="UserRoleDto">
        SELECT
            role_id AS roleId,
            role_name AS roleName,
            role_kor_name AS roleKorName
        FROM
            user_role
    </select>

    <select id="selectAllUserCount" parameterType="hashmap" resultType="int">
        SELECT
            COUNT(*)
        FROM
            user
        WHERE
            state = true
        <choose>
            <when test="searchValue.length != null and searchValue != ''">
                AND
                    nickname LIKE CONCAT('%', #{searchValue}, '%')
            </when>
        </choose>
        <choose>
            <when test="category != 'all'">
                AND
                    role_id = #{category}
            </when>
        </choose>
    </select>

    <select id="selectUserList" parameterType="hashmap" resultMap="UserResultMap">
        SELECT
            u.user_id AS u_user_id,
            u.nickname AS u_nickname,
            u.social_method AS u_social_method,
            u.role_id AS u_role_id,
            u.join_date AS u_join_date,
            u.state AS u_state,

            ur.role_id AS ur_role_id,
            ur.role_name AS ur_role_name,
            ur.role_kor_name AS ur_role_kor_name,

            COALESCE(COUNT(DISTINCT b.board_id), 0) + COALESCE(COUNT(DISTINCT rb.board_id), 0) AS writeBoardCount,
            COALESCE(COUNT(DISTINCT c.comment_id), 0) + COALESCE(COUNT(DISTINCT rc.comment_id), 0) AS writeCommentCount,
            COALESCE(COUNT(DISTINCT r.report_id), 0) AS reportCount,
            (COALESCE(COUNT(DISTINCT b.board_id), 0) + COALESCE(COUNT(DISTINCT rb.board_id), 0)) * 2 + (COALESCE(COUNT(DISTINCT c.comment_id), 0) + COALESCE(COUNT(DISTINCT rc.comment_id), 0)) AS userScore
        FROM
            user u
        LEFT JOIN
            user_role ur
        ON
            u.role_id = ur.role_id
        LEFT JOIN
            board b
        ON
            u.user_id = b.user_id
        LEFT JOIN
            request_board rb
        ON
            u.user_id = rb.user_id
        LEFT JOIN
            comment c
        ON
            u.user_id = c.user_id
        LEFT JOIN
            request_comment rc
        ON
            u.user_id = rc.user_id
        LEFT JOIN
            report r
        ON
            u.user_id = r.user_id
        WHERE
            u.state = true
        <choose>
            <when test="searchValue.length != null and searchValue != ''">
                AND
                    u.nickname LIKE CONCAT('%', #{searchValue}, '%')
            </when>
        </choose>
        <choose>
            <when test="category != 'all'">
                AND
                    u.role_id = #{category}
            </when>
        </choose>
        GROUP BY
            u.user_id
        ORDER BY
            <choose>
                <when test="sortValue == 'score'">
                    (COALESCE(COUNT(DISTINCT b.board_id), 0) + COALESCE(COUNT(DISTINCT rb.board_id), 0)) * 2 + (COALESCE(COUNT(DISTINCT c.comment_id), 0) + COALESCE(COUNT(DISTINCT rc.comment_id), 0)) DESC
                </when>
                <when test="sortValue == 'latest'">
                    u.join_date DESC
                </when>
            </choose>
        LIMIT
            10
        OFFSET
            #{start}
    </select>

    <update id="updateUserRole" parameterType="hashmap">
        UPDATE
            user
        SET
            role_id = #{roleValue}
        WHERE
            user_id = #{userId}
    </update>

    <insert id="insertCompetition" parameterType="hashmap">
        INSERT INTO
            competition (
                competition_name,
                competition_category
            )
        VALUES
            (
                #{value},
                #{competitionCategory}
            )
    </insert>

    <insert id="insertCompetitionRound" parameterType="String">
        INSERT INTO
            competition_round (
                round_name
            )
        VALUES
            (
                #{value}
            )
    </insert>

    <insert id="insertTeam" parameterType="hashmap">
        INSERT INTO
            team (
                team_name,
                logo_address
            )
        VALUES
            (
                #{value},
                #{logo}
            )
    </insert>

    <select id="selectAllTeam" resultType="TeamDto">
        SELECT
            team_id AS teamId,
            team_name AS teamName,
            logo_address AS logoAddress
        FROM
            team
    </select>

    <select id="selectAllCompetition" resultType="CompetitionDto">
        SELECT
            competition_id AS competitionId,
            competition_name AS competitionName,
            competition_category AS competitionCategory,
            champions_league_from AS championsLeagueFrom,
            champions_league_to AS championsLeagueTo,
            other_league_from AS otherLeagueFrom,
            other_league_to AS otherLeagueTo
        FROM
            competition
        ORDER BY
            competition_id ASC
    </select>

    <select id="selectAllCompetitionRound" resultType="CompetitionRoundDto">
        SELECT
            round_id AS roundId,
            round_name AS roundName
        FROM
            competition_round
    </select>

    <insert id="insertSchedule" parameterType="ScheduleDto">
        INSERT INTO
            schedule (
                schedule_date,
                competition_id,
                round_id,
                home_team_id,
                away_team_id
            )
        VALUES
            (
                #{scheduleDate},
                #{competitionId},
                #{roundId},
                #{homeTeamId},
                #{awayTeamId}
            )
    </insert>

    <select id="selectAllCompetitionCount" parameterType="String" resultType="int">
        SELECT
            COUNT(*)
        FROM
            competition
        <choose>
            <when test="searchValue.length != null and searchValue != ''">
                WHERE
                    competition_name LIKE CONCAT('%', #{searchValue}, '%')
            </when>
        </choose>
    </select>

    <select id="selectCompetition" parameterType="hashmap" resultType="CompetitionDto">
        SELECT
            competition_id AS competitionId,
            competition_name AS competitionName,
            competition_category AS competitionCategory
        FROM
            competition
        <choose>
            <when test="searchValue.length != null and searchValue != ''">
                WHERE
                    competition_name LIKE CONCAT('%', #{searchValue}, '%')
            </when>
        </choose>
        ORDER BY
            competition_id DESC
        LIMIT
            10
        OFFSET
            #{start}
    </select>

    <select id="selectAllCompetitionRoundCount" parameterType="String" resultType="int">
        SELECT
            COUNT(*)
        FROM
            competition_round
        <choose>
            <when test="searchValue.length != null and searchValue != ''">
                WHERE
                    round_name LIKE CONCAT('%', #{searchValue}, '%')
            </when>
        </choose>
    </select>

    <select id="selectCompetitionRound" parameterType="hashmap" resultType="CompetitionRoundDto">
        SELECT
            round_id AS roundId,
            round_name AS roundName
        FROM
            competition_round
        <choose>
            <when test="searchValue.length != null and searchValue != ''">
                WHERE
                    round_name LIKE CONCAT('%', #{searchValue}, '%')
            </when>
        </choose>
        ORDER BY
            round_id DESC
        LIMIT
            10
        OFFSET
            #{start}
    </select>

    <select id="selectAllTeamCount" parameterType="String" resultType="int">
        SELECT
            COUNT(*)
        FROM
            team
        <choose>
            <when test="searchValue.length != null and searchValue != ''">
                WHERE
                    team_name LIKE CONCAT('%', #{searchValue}, '%')
            </when>
        </choose>
    </select>

    <select id="selectTeam" parameterType="hashmap" resultType="TeamDto">
        SELECT
            team_id AS teamId,
            team_name AS teamName,
            logo_address AS logoAddress
        FROM
            team
        <choose>
            <when test="searchValue.length != null and searchValue != ''">
                WHERE
                    team_name LIKE CONCAT('%', #{searchValue}, '%')
            </when>
        </choose>
        ORDER BY
            team_id DESC
        LIMIT
            10
        OFFSET
            #{start}
    </select>

    <update id="updateCompetitionName" parameterType="hashmap">
        UPDATE
            competition
        SET
            competition_name = #{name},
            competition_category = #{competitionCategory}
        WHERE
            competition_id = #{id}
    </update>

    <update id="updateCompetitionRoundName" parameterType="hashmap">
        UPDATE
            competition_round
        SET
            round_name = #{name}
        WHERE
            round_id = #{id}
    </update>

    <update id="updateTeam" parameterType="hashmap">
        UPDATE
            team
        <choose>
            <when test="name.length == null or name == ''">
                SET
                    logo_address = #{logo}
            </when>
            <when test="logo.length == null or logo == ''">
                SET
                    team_name = #{name}
            </when>
            <otherwise>
                SET
                    team_name = #{name},
                    logo_address = #{logo}
            </otherwise>
        </choose>
        WHERE
            team_id = #{id}
    </update>

    <delete id="deleteTeam" parameterType="hashmap">
        DELETE FROM
            <choose>
                <when test="category == 'competition'">
                    competition
                </when>
                <when test="category == 'round'">
                    competition_round
                </when>
                <when test="category == 'team'">
                    team
                </when>
            </choose>
        WHERE
            <choose>
                <when test="category == 'competition'">
                    competition_id = #{id}
                </when>
                <when test="category == 'round'">
                    round_id = #{id}
                </when>
                <when test="category == 'team'">
                    team_id = #{id}
                </when>
            </choose>
    </delete>

    <select id="selectAllScheduleCount" parameterType="hashmap" resultType="int">
        SELECT
            COUNT(*)
        FROM
            schedule s
        LEFT JOIN
            competition c
        ON
            s.competition_id = c.competition_id
        LEFT JOIN
            competition_round cr
        ON
            s.round_id = cr.round_id
        LEFT JOIN
            team ht
        ON
            s.home_team_id = ht.team_id
        LEFT JOIN
            team at
        ON
            s.away_team_id = at.team_id
        <where>
            <if test="fromDay != null and tillDay != null">
                s.schedule_date &gt;= #{fromDay}
                AND s.schedule_date &lt; #{tillDay}
            </if>

            <if test="category != null and category != 'all'">
                AND c.competition_id = #{category}
            </if>
        </where>
    </select>

    <select id="selectSchedule" parameterType="hashmap" resultMap="ScheduleResultMap">
        SELECT
            s.schedule_id AS s_schedule_id,
            s.schedule_date AS s_schedule_date,
            s.competition_id AS s_competition_id,
            s.round_id AS s_round_id,
            s.home_team_id AS s_home_team_id,
            s.away_team_id AS s_away_team_id,

            c.competition_id AS c_competition_id,
            c.competition_name AS c_competition_name,
            c.competition_category AS c_competition_category,

            cr.round_id AS cr_round_id,
            cr.round_name AS cr_round_name,

            ht.team_id AS ht_team_id,
            ht.team_name AS ht_team_name,
            ht.logo_address AS ht_logo_address,

            at.team_id AS at_team_id,
            at.team_name AS at_team_name,
            at.logo_address AS at_logo_address
        FROM
            schedule s
        LEFT JOIN
            competition c
        ON
            s.competition_id = c.competition_id
        LEFT JOIN
            competition_round cr
        ON
            s.round_id = cr.round_id
        LEFT JOIN
            team ht
        ON
            s.home_team_id = ht.team_id
        LEFT JOIN
            team at
        ON
            s.away_team_id = at.team_id
        <where>
            <if test="fromDay != null and tillDay != null">
                s.schedule_date &gt;= #{fromDay}
                AND s.schedule_date &lt; #{tillDay}
            </if>

            <if test="category != null and category != 'all'">
                AND c.competition_id = #{category}
            </if>
        </where>
        ORDER BY
            s.competition_id,
            s.schedule_date
        LIMIT
            10
        OFFSET
            #{start}
    </select>

    <update id="updateSchedule" parameterType="hashmap">
        UPDATE
            schedule
        SET
            schedule_date = #{date}
            , competition_id = #{schedule.competitionId}
            , round_id = #{schedule.roundId}
            <choose>
                <when test="schedule.homeTeamId != 0 or schedule.homeTeamId == null">
                    , home_team_id = #{schedule.homeTeamId}
                </when>
            </choose>
            <choose>
                <when test="schedule.awayTeamId != 0 or schedule.awayTeamId == null">
                    , away_team_id = #{schedule.awayTeamId}
                </when>
            </choose>
        WHERE
            schedule_id = #{schedule.scheduleId}
    </update>

    <delete id="deleteSchedule" parameterType="int">
        DELETE FROM
            schedule
        WHERE
            schedule_id = #{scheduleId}
    </delete>

    <select id="selectRankingWithSeasonAndTeamId" parameterType="hashmap" resultType="RankingDto">
        SELECT
            ranking_id AS rankingId,
            season AS season,
            competition_id AS competitionId,
            team_id AS teamId,
            win,
            draw,
            lose,
            score_point AS scorePoint,
            lose_point AS losePoint
        FROM
            ranking
        WHERE
            season = #{seasonValue}
        AND
            team_id = #{teamId}
    </select>

    <insert id="insertRanking" parameterType="hashmap">
        INSERT INTO
            ranking (
                season,
                competition_id,
                team_id,
                win,
                draw,
                lose,
                score_point,
                lose_point
            )
        VALUES (
                #{seasonValue},
                #{competitionId},
                #{teamId},
                <choose>
                    <when test="result == 'win'">
                        1,
                        0,
                        0,
                    </when>
                    <when test="result == 'lose'">
                        0,
                        0,
                        1,
                    </when>
                    <when test="result == 'draw'">
                        0,
                        1,
                        0,
                    </when>
                </choose>
                #{scorePoint},
                #{losePoint}
            )
    </insert>

    <update id="updateRanking" parameterType="RankingDto">
        UPDATE
            ranking
        SET
            win = #{win},
            draw = #{draw},
            lose = #{lose},
            score_point = #{scorePoint},
            lose_point = #{losePoint}
        WHERE
            ranking_id = #{rankingId}
    </update>

    <update id="updateCompetitionLeague" parameterType="hashmap">
        UPDATE
            competition
        SET
            champions_league_from = #{clFrom},
            champions_league_to = #{clTo},
            other_league_from = #{olFrom},
            other_league_to = #{olTo}
        WHERE
            competition_id = #{competitionId}
    </update>

    <select id="selectRanking" parameterType="hashmap" resultMap="RankingResultMap">
        SELECT
            r.ranking_id AS r_ranking_id,
            r.season AS r_season,
            r.competition_id AS r_competition_id,
            r.team_id AS r_team_id,
            r.win + r.draw + r.lose AS r_match_count,
            (r.win * 3) + r.draw AS r_point,
            r.win AS r_win,
            r.draw AS r_draw,
            r.lose AS r_lose,
            r.score_point AS r_score_point,
            r.lose_point AS r_lose_point,

            c.competition_id AS c_competition_id,
            c.competition_name AS c_competition_name,
            c.competition_category AS c_competition_category,
            c.champions_league_from AS c_champions_league_from,
            c.champions_league_to AS c_champions_league_to,
            c.other_league_from AS c_other_league_from,
            c.other_league_to AS c_other_league_to,

            t.team_id AS t_team_id,
            t.team_name AS t_team_name,
            t.logo_address AS t_logo_address
        FROM
            ranking r
        LEFT JOIN
            competition c
        ON
            r.competition_id = c.competition_id
        LEFT JOIN
            team t
        ON
            r.team_id = t.team_id
        WHERE
            r.competition_id = #{competitionValue}
        AND
            r.season = #{seasonValue}
        ORDER BY
            (r.win * 3) + r.draw DESC,
            r.score_point - r.lose_point DESC
    </select>

</mapper>