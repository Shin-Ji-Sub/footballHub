<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Text Editor -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <!-- Custom -->
    <link rel="stylesheet" href="/main.css">
    <link rel="stylesheet" href="/write.css">
    <title>FootballHub</title>
</head>
<body>
    <div th:replace="~{/modules/header}"></div>

    <form id="writeBoardForm" action="/board/modify-board" method="POST" enctype="multipart/form-data">
    <main>
        <div class="main-container">
            <div class="board-container">
                <ul>
                    <li>íŒŒì¼ í˜•íƒœ ì œí•œ</li>
                    <li>íŒŒì¼ í¬ê¸° ì œí•œ</li>
                    <li>ë¹„í•˜ ìì œ</li>
                </ul>
                <div class="write-header">
                    <!-- í° ì¹´í…Œê³ ë¦¬ -->
                    <select name="largeCategoryId" class="form-select write-subject" id="writeLargeCategory" aria-label="Default select example">
                        <th:block th:each="largeCategory : ${largeCategories}">
                            <option th:if="${largeCategory.largeCategoryId == board.largeCategory.largeCategoryId}"
                                    th:value="${largeCategory.largeCategoryId}"
                                    th:text="${largeCategory.largeCategoryName}"
                                    selected></option>
                            <option th:if="${largeCategory.largeCategoryId != board.largeCategory.largeCategoryId}"
                                    th:value="${largeCategory.largeCategoryId}"
                                    th:text="${largeCategory.largeCategoryName}"></option>
                        </th:block>
                    </select>

                    <!-- ì¼ë°˜ (ì‘ì€ ì¹´í…Œê³ ë¦¬) -->
                    <th:block th:if="${board.largeCategory.largeCategoryId == 1}">
                        <select name="smallCategoryIndex" class="form-select write-subject" id="normalCategory" aria-label="Default select example">
                            <th:block th:each="largeCategory : ${largeCategories}"
                                      th:if="${largeCategory.largeCategoryId == 1}">
                                <th:block th:each="smallCategory : ${largeCategory.smallCategories}">
                                    <option th:if="${smallCategory.smallCategoryIndex == board.smallCategory.smallCategoryIndex}"
                                            th:value="${smallCategory.smallCategoryIndex}"
                                            th:text="${smallCategory.smallCategoryName}"
                                            selected></option>
                                    <option th:if="${smallCategory.smallCategoryIndex != board.smallCategory.smallCategoryIndex}"
                                            th:value="${smallCategory.smallCategoryIndex}"
                                            th:text="${smallCategory.smallCategoryName}"></option>
                                </th:block>
                            </th:block>
                        </select>
                    </th:block>
                    <th:block th:if="${board.largeCategory.largeCategoryId != 1}">
                        <select name="smallCategoryIndex" class="form-select write-subject display-none" id="normalCategory" aria-label="Default select example">
                            <th:block th:each="largeCategory : ${largeCategories}"
                                      th:if="${largeCategory.largeCategoryId == 1}">
                                <th:block th:each="smallCategory : ${largeCategory.smallCategories}">
                                    <option th:if="${smallCategory.smallCategoryIndex == board.smallCategory.smallCategoryIndex}"
                                            th:value="${smallCategory.smallCategoryIndex}"
                                            th:text="${smallCategory.smallCategoryName}"
                                            selected></option>
                                    <option th:if="${smallCategory.smallCategoryIndex != board.smallCategory.smallCategoryIndex}"
                                            th:value="${smallCategory.smallCategoryIndex}"
                                            th:text="${smallCategory.smallCategoryName}"></option>
                                </th:block>
                            </th:block>
                        </select>
                    </th:block>

                    <!-- ì„ íƒëœ íŒ€ (ê³µí™”êµ­), (ì‘ì€ ì¹´í…Œê³ ë¦¬) -->
                    <th:block th:if="${board.largeCategory.largeCategoryId == 2}">
                        <div class="input-group flex-nowrap" id="teamValueContainer">
                            <input readonly type="text" id="teamValue" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="addon-wrapping"
                                    th:value="${board.smallCategory.smallCategoryName}">
                            <input type="hidden" name="smallCategoryIndex" id="teamIndexValue"
                                    th:value="${board.smallCategory.smallCategoryIndex}">
                            <span class="input-group-text" id="addon-wrapping">
                              <i class="bi bi-arrow-clockwise"></i>
                            </span>
                        </div>

                        <div class="search-team-container display-none" id="fanCategory">
                            <!-- íŒ€ ê²€ìƒ‰ -->
                            <input type="text" class="team-search-value" id="teamSearchValue" placeholder="íŒ€ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
                            <!-- íŒ€ ì„ íƒ -->
                            <div id="appendTeam">
                                <th:block th:each="largeCategory : ${largeCategories}"
                                          th:if="${largeCategory.largeCategoryId == 2}">
                                    <div th:each="smallCategory : ${largeCategory.smallCategories}"
                                         th:data-value="${smallCategory.smallCategoryIndex}"
                                         th:text="${smallCategory.smallCategoryName}"
                                         class="search-team"></div>
                                </th:block>
                            </div>
                        </div>
                    </th:block>
                    <th:block th:if="${board.largeCategory.largeCategoryId != 2}">
                        <div class="input-group flex-nowrap display-none" id="teamValueContainer">
                            <input readonly type="text" id="teamValue" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="addon-wrapping"
                                   th:value="${board.smallCategory.smallCategoryName}">
                            <input type="hidden" name="smallCategoryIndex" id="teamIndexValue"
                                   th:value="${board.smallCategory.smallCategoryIndex}">
                            <span class="input-group-text" id="addon-wrapping">
                              <i class="bi bi-arrow-clockwise"></i>
                            </span>
                        </div>

                        <div class="search-team-container display-none" id="fanCategory">
                            <!-- íŒ€ ê²€ìƒ‰ -->
                            <input type="text" class="team-search-value" id="teamSearchValue" placeholder="íŒ€ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
                            <!-- íŒ€ ì„ íƒ -->
                            <div id="appendTeam">
                                <th:block th:each="largeCategory : ${largeCategories}"
                                          th:if="${largeCategory.largeCategoryId == 2}">
                                    <div th:each="smallCategory : ${largeCategory.smallCategories}"
                                         th:data-value="${smallCategory.smallCategoryIndex}"
                                         th:text="${smallCategory.smallCategoryName}"
                                         class="search-team"></div>
                                </th:block>
                            </div>
                        </div>
                    </th:block>
                </div>
                <input type="text" class="write-subject" id="writeSubject" name="subject" placeholder="ì œëª©"
                        th:value="${board.subject}">
                <div id="content"></div>
<!--                <div class="mb-3">-->
<!--                    <label for="formFileMultiple" class="form-label">-->
<!--                        ì²¨ë¶€íŒŒì¼(mp4, webm, movë§Œ ì§€ì›)ì€ ìµœëŒ€ 20MBê¹Œì§€ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.-->
<!--                    </label>-->
<!--                    <input class="form-control" type="file" id="formFileMultiple" accept="video/mp4,video/webm,video/quicktime" multiple>-->
<!--                    <button type="button" class="btn btn-primary mt-2" id="uploadButton">ì—…ë¡œë“œ</button>-->
<!--                </div>-->
            </div>
            <button type="button" id="submitButton" class="write-button">ê¸€ìˆ˜ì •</button>
        </div>
    </main>
    <div class="visibility-hidden" id="hiddenBox">
        <input type="hidden" id="userId" name="userId" th:value="${session.user.userId}">
        <input type="hidden" id="boardId" name="boardId" th:value="${board.boardId}">
    </div>
    </form>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Text Editor -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <script type="text/javascript" th:inline="javascript">
        $(window).on('load', function() {
            const editor = new toastui.Editor({
                    el: document.querySelector('#content'), // ì—ë””í„°ë¥¼ ì ìš©í•  ìš”ì†Œ (ì»¨í…Œì´ë„ˆ)
                    height: '500px',                        // ì—ë””í„° ì˜ì—­ì˜ ë†’ì´ ê°’ (OOOpx || auto)
                    initialEditType: 'wysiwyg',            // ìµœì´ˆë¡œ ë³´ì—¬ì¤„ ì—ë””í„° íƒ€ì… (markdown || wysiwyg)
                    previewStyle: 'vertical',                // ë§ˆí¬ë‹¤ìš´ í”„ë¦¬ë·° ìŠ¤íƒ€ì¼ (tab || vertical)
                    hideModeSwitch: true,
                    placeholder: "ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.",
                    //useDefaultHTMLSanitizer: false,          // ğŸ”¥ ê¸°ë³¸ HTML í•„í„°ë§ ì™„ì „ ë¹„í™œì„±í™”
                    //customHTMLSanitizer: html => html,       // HTML í•„í„°ë§ ë°©ì§€
                    hooks: {
                        async addImageBlobHook(blob, callback) {     // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë¡œì§ ì»¤ìŠ¤í…€
                            try {

                                // 1. ì—ë””í„°ì— ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ë¥¼ FormData ê°ì²´ì— ì €ì¥
                                // (ì´ë•Œ, ì»¨íŠ¸ë¡¤ëŸ¬ uploadEditorImage ë©”ì„œë“œì˜ íŒŒë¼ë¯¸í„°ì¸ 'image'ì™€ formDataì— append í•˜ëŠ” key('image')ê°’ì€ ë™ì¼í•´ì•¼ í•¨)
                                const formData = new FormData();
                                formData.append('image', blob);

                                // 2. FileApiController - uploadEditorImage ë©”ì„œë“œ í˜¸ì¶œ
                                const response = await fetch('/board/image-upload', {
                                    method : 'POST',
                                    body : formData,
                                });

                                // 3. ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì „ë‹¬ë°›ì€ ë””ìŠ¤í¬ì— ì €ì¥ëœ íŒŒì¼ëª…
                                const result = await response.json();
                                console.log('ì„œë²„ì— ì €ì¥ëœ íŒŒì¼ëª… : ', result.userFileName);
                                console.log('ì›ë³¸ íŒŒì¼ëª… : ', result.savedFileName);

                                $('#hiddenBox').append(
                                    `<div class='visibility-hidden image-file'
                                    data-file='{"userFileName": "${result.userFileName}", "savedFileName": "${result.savedFileName}"}'>
                                    </div>`
                                );

                                // 4. addImageBlobHookì˜ callback í•¨ìˆ˜ë¥¼ í†µí•´, ë””ìŠ¤í¬ì— ì €ì¥ëœ ì´ë¯¸ì§€ë¥¼ ì—ë””í„°ì— ë Œë”ë§
                                //const imageUrl = `/board/image-print?filename=${result.savedFileName}`;
                                //callback(imageUrl, 'image alt attribute');

                                callback(`/board/image-print?filename=${result.savedFileName}`);

                            } catch (error) {
                                console.error('ì—…ë¡œë“œ ì‹¤íŒ¨ : ', error);
                            }
                        }
                    }
            });
            editor.setHTML(/*[[${board.content}]]*/'');

            const writeSubject = $('#writeSubject');
            const writeLargeCategory = $('#writeLargeCategory');
            const normalCategory = $('#normalCategory');
            const fanCategory = $('#fanCategory');
            const teamValueContainer = $('#teamValueContainer');
            const contentWidth = $('#content').width();
            const appendTeam = $('#appendTeam');
            const teamSearchValue = $('#teamSearchValue');
            const refreshBtn = $('#addon-wrapping');
            const deleteOption = $('#deleteOption');
            const teamArrEl = $('.search-team');

            // FORM ê´€ë ¨ ë³€ìˆ˜
            const writeBoardForm = $('#writeBoardForm');
            const submitButton = $('#submitButton');
            // ì´ë¯¸ì§€ íŒŒì¼ ì •ê·œì‹
            const regex = /![]\(\/board\/image-print\?filename=([\w-]+\.png)\)/g;

            const width = contentWidth / 2;

            writeSubject.css('width', contentWidth);
            writeLargeCategory.css('width', width);
            normalCategory.css('width', width);
            fanCategory.css('width', width);
            teamValueContainer.css('width', width);

            writeLargeCategory.on('change', () => {
              const writeLargeCategoryValue = writeLargeCategory.val();
              if (writeLargeCategoryValue == 1) {
                deleteOption.remove();
                normalCategory.removeAttr('disabled');
                normalCategory.removeClass('display-none');
                fanCategory.addClass('display-none');
                teamValueContainer.addClass('display-none');
              } else if (writeLargeCategoryValue == 2) {
                fanCategory.removeClass('display-none');
                normalCategory.addClass('display-none');

                appendTeam.css({
                  'bottom' : writeLargeCategory.height() * 2,
                  'max-height': teamArrEl.outerHeight() * 5 + 'px',
                  'overflow-y': 'auto'
                });
              }
            });

            teamSearchValue.on('input', () => {
              const searchValue = teamSearchValue.val();
              const result = teamArrEl.filter((i, el) => $(el).text().trim().includes(searchValue));
              appendTeam.empty();
              for (let i = 0; i < result.length; i++) {
                appendTeam.append(`<div class='search-team'>${$(result[i]).text()}</div>`);
              }
              if (searchValue.length == 0) {
                for (let i = 0; i < teamArrEl.length; i++) {
                  appendTeam.append(`<div class='search-team'>${$(teamArrEl[i]).text()}</div>`);
                }
              }
            });

            appendTeam.on('click', '.search-team', (e) => {
              const value = $(e.target).html();
              const indexValue = $(e.target).data('value');
              $('#teamValue').val(value);
              $('#teamIndexValue').val(indexValue);
              teamValueContainer.removeClass('display-none');
              fanCategory.addClass('display-none');
            });

            refreshBtn.on('click', () => {
              fanCategory.removeClass('display-none');
              teamValueContainer.addClass('display-none');
              appendTeam.css({
                'bottom' : writeLargeCategory.height() * 2,
                'max-height': teamArrEl.outerHeight() * 5 + 'px',
                'overflow-y': 'auto'
              });
            });

            // write ajax submit
            submitButton.on('click', (e) => {
                const writeBoardForm = $('#writeBoardForm');
                const largeCategory = $('#writeLargeCategory').val();
                const normalValue = $('#normalCategory').val();
                const teamValue = $('#teamValue').val();
                const subject = $('#writeSubject').val();
                const content = editor.getHTML();
                const userId = $('#userId').val();

                const imageFiles = $('.image-file');
                const ImageFilesArr = [];
                if (imageFiles.length == 0) {
                    console.log("length = 0");
                } else {
                    for (let i = 0; i < imageFiles.length; i++) {
                        ImageFilesArr.push(imageFiles.eq(i).data('file'));
                    }
                }
                console.log(ImageFilesArr);

                //const matches = [...content.matchAll(regex)].map(match => match[1]);

                if (largeCategory == 'ì¹´í…Œê³ ë¦¬') {
                    alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                    e.preventDefault();
                    return;
                }

                if (largeCategory == 2) {
                    if (teamValue.length == 0) {
                        alert('íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                        teamSearchValue.focus();
                        e.preventDefault();
                        return;
                    }
                }

                if (subject.length == 0) {
                    alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    $('#writeSubject').focus();
                    e.preventDefault();
                    return;
                }

                if (editor.getMarkdown().length == 0) {
                    alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    e.preventDefault();
                    return;
                }

                const data = writeBoardForm.serializeArray();
                if (largeCategory == 1) data.splice(2, 1);
                if (largeCategory == 2) data.splice(1, 1);
                data.push({
                    name : 'content',
                    value : content
                });
                if (ImageFilesArr.length != 0) {
                    data.push({
                        name : 'ImageFilesArr',
                        value : JSON.stringify(ImageFilesArr)
                    });
                }
                console.log(data);
                $.ajax({
                    url : writeBoardForm.attr('action'),
                    method : writeBoardForm.attr('method'),
                    data : data,
                    dataType : "text",
                    success : (response, status, xhr) => {
                        if (response == "success") {
                            alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            location.href="/";
                        };
                    },
                    error : (xhr, status, err) => {
                        alert("ìˆ˜ì •í•˜ì§€ ëª»í•˜ì˜€ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.");
                    }
                });

            });

        });
    </script>
</body>
</html>