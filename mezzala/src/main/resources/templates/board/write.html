<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Text Editor -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <!-- Custom -->
    <link rel="stylesheet" href="/main.css">
    <link rel="stylesheet" href="/write.css">
    <title>FootballHub</title>
</head>
<body>
    <div th:replace="~{modules/header}"></div>

    <form id="writeBoardForm" action="/board/write-board" method="POST" enctype="multipart/form-data">
    <main>
        <div class="main-container">
            <div class="board-container">
                <ul>
                    <li>ë‚´ìš©ì€ 10000ì ì´ë‚´ë¡œ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤. (ê³µë°± í¬í•¨)</li>
                    <li>10MB ì´í•˜ í¬ê¸°ì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                    <li style="font-weight : 600">í˜„ì¬ ê¸€ììˆ˜ : <span id="totalTextSize">0</span> / 10000</li>
                    <li style="font-weight : 600">í˜„ì¬ íŒŒì¼ í¬ê¸° : <span id="totalFileSize">0</span>MB</li>
                </ul>
                <div class="write-header">
                    <select name="largeCategoryId" class="form-select write-subject" id="writeLargeCategory" aria-label="Default select example">
                        <option th:selected="${fromPage == 'home'}" value="0">ì¹´í…Œê³ ë¦¬</option>
                        <option th:each="largeCategory : ${largeCategories}"
                                th:if="${largeCategory.largeCategoryName != 'ê³µì§€ì‚¬í•­'}"
                                th:value="${largeCategory.largeCategoryId}"
                                th:text="${largeCategory.largeCategoryName}"
                                th:selected="${largeCategory.largeCategoryName == categoryText}"></option>
                    </select>
                    <div id="smallCategoryModule">
                        <!-- ì‘ì€ ì¹´í…Œê³ ë¦¬ Module -->
                    </div>
                </div>
                <input type="text" class="write-subject" id="writeSubject" name="subject" placeholder="ì œëª©">
                <div id="content"></div>
<!--                <div class="mb-3">-->
<!--                    <label for="formFileMultiple" class="form-label">-->
<!--                        ì²¨ë¶€íŒŒì¼(mp4, webm, movë§Œ ì§€ì›)ì€ ìµœëŒ€ 20MBê¹Œì§€ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.-->
<!--                    </label>-->
<!--                    <input class="form-control" type="file" id="formFileMultiple" accept="video/mp4,video/webm,video/quicktime" multiple>-->
<!--                    <button type="button" class="btn btn-primary mt-2" id="uploadButton">ì—…ë¡œë“œ</button>-->
<!--                </div>-->
            </div>
            <button type="button" id="submitButton" class="write-button">ê¸€ì‘ì„±</button>
        </div>
    </main>
    <div class="visibility-hidden" id="hiddenBox">
        <input type="hidden" id="userId" name="userId" th:value="${session.user.userId}">
    </div>
    </form>
    <input type="hidden" id="fromPage" th:value="${fromPage}">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Text Editor -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
</body>
<!--<script type="text/javascript" th:inline="javascript">-->
<script type="text/javascript" th:inline="none">
    $(window).on('load', function() {
        let totalUploadedSize = 0;
        const MAX_TEXT_LENGTH = 10000;
        const MAX_FILE_SIZE = 10 * 1024 * 1024;     // ê°œë³„ íŒŒì¼ ì œí•œ: 10MB
        const MAX_TOTAL_SIZE = 10 * 1024 * 1024;     // ì „ì²´ ëˆ„ì  ì œí•œ: 10MB
        let lastValidContent = ""; // ë§ˆì§€ë§‰ ìœ íš¨í•œ í…ìŠ¤íŠ¸ ì €ì¥
        let uploadedImageSizeMap = new Map(); // key: savedFileName, value: blob.size
        let currentlyVisibleImages = new Set();           // ì´ì „ change ì‹œì ì— ì—ë””í„°ì— í‘œì‹œë˜ë˜ ì´ë¯¸ì§€ ëª©ë¡

        const editor = new toastui.Editor({
            el: document.querySelector('#content'), // ì—ë””í„°ë¥¼ ì ìš©í•  ìš”ì†Œ (ì»¨í…Œì´ë„ˆ)
            height: '500px',                        // ì—ë””í„° ì˜ì—­ì˜ ë†’ì´ ê°’ (OOOpx || auto)
            initialEditType: 'wysiwyg',            // ìµœì´ˆë¡œ ë³´ì—¬ì¤„ ì—ë””í„° íƒ€ì… (markdown || wysiwyg)
            previewStyle: 'vertical',                // ë§ˆí¬ë‹¤ìš´ í”„ë¦¬ë·° ìŠ¤íƒ€ì¼ (tab || vertical)
            hideModeSwitch: true,
            placeholder: "ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.",
            //useDefaultHTMLSanitizer: false,          // ğŸ”¥ ê¸°ë³¸ HTML í•„í„°ë§ ì™„ì „ ë¹„í™œì„±í™”
            //customHTMLSanitizer: html => html,       // HTML í•„í„°ë§ ë°©ì§€
            hooks: {
                async addImageBlobHook(blob, callback) {     // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë¡œì§ ì»¤ìŠ¤í…€
                    try {

                        // 1. ê°œë³„ ì´ë¯¸ì§€ í¬ê¸° ê²€ì‚¬
                        if (blob.size > MAX_FILE_SIZE) {
                            alert("ì´ë¯¸ì§€ íŒŒì¼ì€ 10MB ì´í•˜ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                            return;
                        }

                        // 2. ì „ì²´ ëˆ„ì  í¬ê¸° ê²€ì‚¬
                        if (totalUploadedSize + blob.size > MAX_TOTAL_SIZE) {
                            alert("ì „ì²´ ì—…ë¡œë“œ ìš©ëŸ‰ì€ 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                            return;
                        }

                        // 3. ëˆ„ì  í¬ê¸° ë°˜ì˜ ë° í™”ë©´ í‘œì‹œ
                        totalUploadedSize += blob.size;
                        const totalMB = (totalUploadedSize / (1024 * 1024)).toFixed(2);
                        $('#totalFileSize').text(totalMB);

                        // 1. ì—ë””í„°ì— ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ë¥¼ FormData ê°ì²´ì— ì €ì¥
                        // (ì´ë•Œ, ì»¨íŠ¸ë¡¤ëŸ¬ uploadEditorImage ë©”ì„œë“œì˜ íŒŒë¼ë¯¸í„°ì¸ 'image'ì™€ formDataì— append í•˜ëŠ” key('image')ê°’ì€ ë™ì¼í•´ì•¼ í•¨)
                        const formData = new FormData();
                        formData.append('image', blob);

                        // 2. FileApiController - uploadEditorImage ë©”ì„œë“œ í˜¸ì¶œ
                        const response = await fetch('/board/image-upload', {
                            method : 'POST',
                            body : formData,
                        });

                        // 3. ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì „ë‹¬ë°›ì€ ë””ìŠ¤í¬ì— ì €ì¥ëœ íŒŒì¼ëª…
                        const result = await response.json();
                        // Mapì— ì´ë¯¸ì§€ ì´ë¦„, í¬ê¸° ì €ì¥
                        uploadedImageSizeMap.set(result.savedFileName, blob.size);
                        console.log('ì„œë²„ì— ì €ì¥ëœ íŒŒì¼ëª… : ', result.userFileName);
                        console.log('ì›ë³¸ íŒŒì¼ëª… : ', result.savedFileName);

                        $('#hiddenBox').append(
                            `<div class='visibility-hidden image-file'
                            data-file='{"userFileName": "${result.userFileName}", "savedFileName": "${result.savedFileName}", "fileSize": "${blob.size}"}'>
                            </div>`
                        );

                        // 4. addImageBlobHookì˜ callback í•¨ìˆ˜ë¥¼ í†µí•´, ë””ìŠ¤í¬ì— ì €ì¥ëœ ì´ë¯¸ì§€ë¥¼ ì—ë””í„°ì— ë Œë”ë§
                        //const imageUrl = `/board/image-print?filename=${result.savedFileName}`;
                        //callback(imageUrl, 'image alt attribute');

                        callback(`/board/image-print?filename=${result.savedFileName}`);

                    } catch (error) {
                        console.error('ì—…ë¡œë“œ ì‹¤íŒ¨ : ', error);
                    }
                }
            }
        });

        editor.on('change', () => {
            let textContent = editor.getMarkdown(); // ë˜ëŠ” getHTML(), getText() ë„ ê°€ëŠ¥

            // 1. í˜„ì¬ ë§ˆí¬ë‹¤ìš´ì—ì„œ ì´ë¯¸ì§€ URL ì¶”ì¶œ
            const imageMarkdownRegex = /!\[[^\]]*\]\((.*?)\)/g;
            const imageUrls = [...textContent.matchAll(imageMarkdownRegex)].map(match => match[1]);
            const fileNameRegex = /filename=([^&\)]+)/;

            const currentImageFiles = new Set(
                imageUrls.map(url => {
                    const match = url.match(fileNameRegex);
                    return match ? match[1] : null;
                }).filter(f => f !== null)
            );

            // 2. ì‚­ì œëœ ì´ë¯¸ì§€ ì°¾ê¸° (ì´ì „ Set - í˜„ì¬ Set)
            for (const fileName of currentlyVisibleImages) {
                if (!currentImageFiles.has(fileName)) {
                    // ì‚­ì œëœ ì´ë¯¸ì§€ â†’ Mapì—ì„œ ì œê±°
                    if (uploadedImageSizeMap.has(fileName)) {
                        const size = uploadedImageSizeMap.get(fileName);
                        totalUploadedSize -= size;
                        uploadedImageSizeMap.delete(fileName);
                    }

                    // ì‚­ì œëœ ì´ë¯¸ì§€ì— í•´ë‹¹í•˜ëŠ” div ì œê±°
                    $(`.image-file`).each(function () {
                        const data = $(this).data('file');
                        if (data && data.savedFileName === fileName) {
                            $(this).remove(); // div ì œê±°
                        }
                    });
                }
            }

            // 3. í˜„ì¬ ìƒíƒœë¡œ ì—…ë°ì´íŠ¸
            currentlyVisibleImages = currentImageFiles;

            // 4. í‘œì‹œ ì¤‘ì¸ ì´ë¯¸ì§€ ì´ ìš©ëŸ‰ ê³„ì‚°
            let currentVisibleImageSize = 0;
            for (const fileName of currentImageFiles) {
                if (uploadedImageSizeMap.has(fileName)) {
                    currentVisibleImageSize += uploadedImageSizeMap.get(fileName);
                }
            }

            const visibleImageSizeMB = (currentVisibleImageSize / (1024 * 1024)).toFixed(2);
            $('#totalFileSize').text(visibleImageSizeMB);

            textContent = textContent.replace(/!\[[^\]]*\]\([^\)]*\)/g, '');
            const length = textContent.length;

            if (length > MAX_TEXT_LENGTH) {
                alert("ìµœëŒ€ 10,000ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                editor.setMarkdown(lastValidContent); // ì´ì „ ìƒíƒœë¡œ ë¡¤ë°±
                return;
            }

            lastValidContent = textContent; // ìœ íš¨í•œ í…ìŠ¤íŠ¸ ì €ì¥
            $('#totalTextSize').text(length);
        });

        const writeSubject = $('#writeSubject');
        const writeLargeCategory = $('#writeLargeCategory');
        const smallCategoryModule = $('#smallCategoryModule');
        const fromPage = $('#fromPage').val();

        // FORM ê´€ë ¨ ë³€ìˆ˜
        const writeBoardForm = $('#writeBoardForm');
        const submitButton = $('#submitButton');
        // ì´ë¯¸ì§€ íŒŒì¼ ì •ê·œì‹
        const regex = /![]\(\/board\/image-print\?filename=([\w-]+\.png)\)/g;

        // ì‘ì€ ì¹´í…Œê³ ë¦¬ LOAD
        smallCategoryModule.load("/board/get-small-category?largeCategory=" + writeLargeCategory.val());

        // í° ì¹´í…Œê³ ë¦¬ ì„¤ì • í•¨ìˆ˜
        function setLargeCategory() {
            const writeLargeCategoryValue = writeLargeCategory.val();

            if (writeLargeCategoryValue != 0) {
                smallCategoryModule.load("/board/get-small-category?largeCategory=" + writeLargeCategoryValue, () => {
                    $('#smallCategory').removeAttr('disabled');
                });
            }
        }
        // ì´ˆê¸° í° ì¹´í…Œê³ ë¦¬ ì„¤ì •
        setLargeCategory();

        // í° ì¹´í…Œê³ ë¦¬ ë³€ê²½
        writeLargeCategory.on('change', () => {
            setLargeCategory();
        });

        // write ajax submit
        submitButton.on('click', (e) => {
            const writeBoardForm = $('#writeBoardForm');
            const largeCategory = $('#writeLargeCategory').val();
            const smallCategory = $('#smallCategory').val();
            const subject = $('#writeSubject').val();
            const content = editor.getHTML();
            const userId = $('#userId').val();

            const imageFiles = $('.image-file');
            const ImageFilesArr = [];
            if (imageFiles.length != 0) {
                for (let i = 0; i < imageFiles.length; i++) {
                    ImageFilesArr.push(imageFiles.eq(i).data('file'));
                }
            }

            if (largeCategory == 0) {
                alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                e.preventDefault();
                return;
            }

            if (smallCategory == 0) {
                alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                e.preventDefault();
                return;
            }

            if (subject.length == 0) {
                alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                $('#writeSubject').focus();
                e.preventDefault();
                return;
            }

            if (editor.getMarkdown().length == 0) {
                alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                e.preventDefault();
                return;
            }

            const data = writeBoardForm.serializeArray();

            data.push({
                name : 'content',
                value : content
            });
            if (ImageFilesArr.length != 0) {
                data.push({
                    name : 'ImageFilesArr',
                    value : JSON.stringify(ImageFilesArr)
                });
            }

            $.ajax({
                url : writeBoardForm.attr('action'),
                method : writeBoardForm.attr('method'),
                data : data,
                dataType : "text",
                success : (response, status, xhr) => {
                    if (response == "success") {
                        alert('ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        if (fromPage == 'normalhub' || fromPage == 'fandomhub') {
                            location.href=`/${fromPage}/home`;
                        } else {
                            location.href=`/${fromPage}`;
                        }
                    };
                },
                error : (xhr, status, err) => {
                    alert("ì‘ì„±í•˜ì§€ ëª»í•˜ì˜€ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‘ì„±í•´ì£¼ì„¸ìš”.");
                }
            });

        });

    });
</script>
</html>