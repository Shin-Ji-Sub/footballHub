<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Text Editor -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <!-- Custom -->
    <link rel="stylesheet" href="/main.css">
    <link rel="stylesheet" href="/write.css">
    <title>FootballHub</title>
</head>
<body>
    <div th:replace="~{admin/modules/header}"></div>

    <form id="writeBoardForm" action="/admin/write-board" method="POST" enctype="multipart/form-data">
    <main>
        <div class="main-container">
            <h3>ê³µì§€ì‚¬í•­ ì‘ì„±</h3>
            <div class="board-container">
                <input type="text" class="write-subject" id="writeSubject" name="subject" placeholder="ì œëª©">
                <div id="content"></div>
            </div>
            <button type="button" id="submitButton" class="write-button">ê¸€ì‘ì„±</button>
        </div>
    </main>
    <div class="visibility-hidden" id="hiddenBox">
        <input type="hidden" id="userId" name="userId" th:value="${session.user.userId}">
        <input type="hidden" name="largeCategoryId" value="3">
    </div>
    </form>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Text Editor -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
</body>
<script type="text/javascript" th:inline="javascript">
    $(window).on('load', function() {
        const editor = new toastui.Editor({
            el: document.querySelector('#content'), // ì—ë””í„°ë¥¼ ì ìš©í•  ìš”ì†Œ (ì»¨í…Œì´ë„ˆ)
            height: '500px',                        // ì—ë””í„° ì˜ì—­ì˜ ë†’ì´ ê°’ (OOOpx || auto)
            initialEditType: 'wysiwyg',            // ìµœì´ˆë¡œ ë³´ì—¬ì¤„ ì—ë””í„° íƒ€ì… (markdown || wysiwyg)
            previewStyle: 'vertical',                // ë§ˆí¬ë‹¤ìš´ í”„ë¦¬ë·° ìŠ¤íƒ€ì¼ (tab || vertical)
            hideModeSwitch: true,
            placeholder: "ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.",
            //useDefaultHTMLSanitizer: false,          // ğŸ”¥ ê¸°ë³¸ HTML í•„í„°ë§ ì™„ì „ ë¹„í™œì„±í™”
            //customHTMLSanitizer: html => html,       // HTML í•„í„°ë§ ë°©ì§€
            hooks: {
                async addImageBlobHook(blob, callback) {     // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë¡œì§ ì»¤ìŠ¤í…€
                    try {

                        // 1. ì—ë””í„°ì— ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ë¥¼ FormData ê°ì²´ì— ì €ì¥
                        // (ì´ë•Œ, ì»¨íŠ¸ë¡¤ëŸ¬ uploadEditorImage ë©”ì„œë“œì˜ íŒŒë¼ë¯¸í„°ì¸ 'image'ì™€ formDataì— append í•˜ëŠ” key('image')ê°’ì€ ë™ì¼í•´ì•¼ í•¨)
                        const formData = new FormData();
                        formData.append('image', blob);

                        // 2. FileApiController - uploadEditorImage ë©”ì„œë“œ í˜¸ì¶œ
                        const response = await fetch('/board/image-upload', {
                            method : 'POST',
                            body : formData,
                        });

                        // 3. ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì „ë‹¬ë°›ì€ ë””ìŠ¤í¬ì— ì €ì¥ëœ íŒŒì¼ëª…
                        const result = await response.json();
                        console.log('ì„œë²„ì— ì €ì¥ëœ íŒŒì¼ëª… : ', result.userFileName);
                        console.log('ì›ë³¸ íŒŒì¼ëª… : ', result.savedFileName);

                        $('#hiddenBox').append(
                            `<div class='visibility-hidden image-file'
                            data-file='{"userFileName": "${result.userFileName}", "savedFileName": "${result.savedFileName}"}'>
                            </div>`
                        );

                        // 4. addImageBlobHookì˜ callback í•¨ìˆ˜ë¥¼ í†µí•´, ë””ìŠ¤í¬ì— ì €ì¥ëœ ì´ë¯¸ì§€ë¥¼ ì—ë””í„°ì— ë Œë”ë§
                        //const imageUrl = `/board/image-print?filename=${result.savedFileName}`;
                        //callback(imageUrl, 'image alt attribute');

                        callback(`/board/image-print?filename=${result.savedFileName}`);

                    } catch (error) {
                        console.error('ì—…ë¡œë“œ ì‹¤íŒ¨ : ', error);
                    }
                }
            }
        });

        const writeSubject = $('#writeSubject');
        const contentWidth = $('#content').width();
        const deleteFirstOption = $('#deleteFirstOption');
        const deleteSecondOption = $('#deleteSecondOption');
        const teamArrEl = $('.search-team');

        // í˜„ì¬ page navì— í‘œì‹œ
        const locationCategories = $('.location-category');
        locationCategories.eq(0).addClass('active');
        locationCategories.eq(0).addClass('text-primary');

        // FORM ê´€ë ¨ ë³€ìˆ˜
        const writeBoardForm = $('#writeBoardForm');
        const submitButton = $('#submitButton');
        // ì´ë¯¸ì§€ íŒŒì¼ ì •ê·œì‹
        const regex = /![]\(\/board\/image-print\?filename=([\w-]+\.png)\)/g;

        const width = contentWidth / 2;

        writeSubject.css('width', contentWidth);

        // write ajax submit
        submitButton.on('click', (e) => {
            const writeBoardForm = $('#writeBoardForm');
            const subject = $('#writeSubject').val();
            const content = editor.getHTML();
            const userId = $('#userId').val();

            const imageFiles = $('.image-file');
            const ImageFilesArr = [];
            if (imageFiles.length != 0) {
                for (let i = 0; i < imageFiles.length; i++) {
                    ImageFilesArr.push(imageFiles.eq(i).data('file'));
                }
            }

            if (subject.length == 0) {
                alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                $('#writeSubject').focus();
                e.preventDefault();
                return;
            }

            if (editor.getMarkdown().length == 0) {
                alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                e.preventDefault();
                return;
            }

            const data = writeBoardForm.serializeArray();
            data.push({
                name : 'content',
                value : content
            });
            if (ImageFilesArr.length != 0) {
                data.push({
                    name : 'ImageFilesArr',
                    value : JSON.stringify(ImageFilesArr)
                });
            }
            console.log(data);
            $.ajax({
                url : writeBoardForm.attr('action'),
                method : writeBoardForm.attr('method'),
                data : data,
                dataType : "text",
                success : (response, status, xhr) => {
                    if (response == "success") {
                        alert('ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        location.href = "/admin/notice";
                    };
                },
                error : (xhr, status, err) => {
                    alert("ì‘ì„±í•˜ì§€ ëª»í•˜ì˜€ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‘ì„±í•´ì£¼ì„¸ìš”.");
                }
            });

        });

    });
</script>
</html>