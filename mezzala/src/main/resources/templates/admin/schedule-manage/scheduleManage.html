<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/main.css">
    <link rel="stylesheet" href="/admin.css">
    <title>FootballHub</title>
</head>
<body>
    <div th:replace="~{/admin/modules/header}"></div>
    <input id="socialMethod" type="hidden" th:if="${session.user != null}" th:value="${session.user.socialMethod}">

    <main>
        <div class="main-container">
            <!-- 일정 INSERT -->
            <div class="container section schedule-container">
                <h4>일정 입력</h4>
                <div>
                    <h5>경기 날짜</h5>
                    <div class="date-select-container">
                        <div class="date-select">
                            <select id="yearSelect" class="form-select" aria-label="Default select example"></select>
                            <span>년</span>
                        </div>
                        <div class="date-select">
                            <select id="monthSelect" class="form-select" aria-label="Default select example"></select>
                            <span>월</span>
                        </div>
                        <div class="date-select">
                            <select id="daySelect" class="form-select" aria-label="Default select example"></select>
                            <span>일</span>
                        </div>
                        <div class="date-select">
                            <select id="hourSelect" class="form-select" aria-label="Default select example"></select>
                            <span>시</span>
                        </div>
                        <div class="date-select">
                            <select id="minuteSelect" class="form-select" aria-label="Default select example"></select>
                            <span>분</span>
                        </div>
                    </div>
                </div>
                <div class="grid-select-container">
                    <div>
                        <h5>대회명</h5>
                        <select id="competitionName" class="form-select" aria-label="Default select example">
                            <option th:each="comp : ${competitions}"
                                    th:value="${comp.competitionId}"
                                    th:text="${comp.competitionName}"></option>
                        </select>
                    </div>
                    <div>
                        <h5>라운드/주차</h5>
                        <select id="roundName" class="form-select" aria-label="Default select example">
                            <option th:each="round : ${rounds}"
                                    th:value="${round.roundId}"
                                    th:text="${round.roundName}"></option>
                        </select>
                    </div>
                </div>
                <div class="grid-select-container">
                    <div>
                        <h5>홈팀</h5>
                        <div class="input-group" data-value="home">
                            <input type="text" class="form-control team-value" id="homeTeam" placeholder="팀 검색">
                            <input type="hidden" id="homeTeamId">
                            <button class="btn btn-outline-secondary team-search-button" type="button">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <h5>어웨이팀</h5>
                        <div class="input-group" data-value="away">
                            <input type="text" class="form-control team-value" id="awayTeam" placeholder="팀 검색">
                            <input type="hidden" id="awayTeamId">
                            <button class="btn btn-outline-secondary team-search-button" type="button">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-primary schedule-save-button" id="saveScheduleButton">저장</button>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">팀 선택</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h2 class="fs-5">팀 검색</h2>
                    <input type="text" class="team-search" id="teamSearchValue">
                    <hr>
                    <h2 class="fs-5">팀 목록</h2>
                    <p class="fandom-item-container">
                        <span class="btn btn-outline-primary fandom-item"
                              th:each="team : ${teams}"
                              th:data-value="${team.teamId}"
                              th:text="${team.teamName}"></span>
                    </p>
                    <input type="hidden" id="modalFromValue">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script type="text/javascript" th:inline="javascript">
        $(window).on('load', function() {
            // 현재 page nav에 표시
            const locationCategories = $('.location-category');
            locationCategories.eq(4).addClass('active');
            locationCategories.eq(4).addClass('text-primary');

            /* 일정 Section */
            const teamValue = $('.team-value');
            const teamSearchButton = $('.team-search-button');
            const modalFromValue = $('#modalFromValue');
            const teamSearchValue = $('#teamSearchValue');

            const currentYear = new Date().getFullYear();

            const saveScheduleButton = $('#saveScheduleButton');
            const yearSelect = $('#yearSelect');
            const monthSelect = $('#monthSelect');
            const daySelect = $('#daySelect');
            const hourSelect = $('#hourSelect');
            const minuteSelect = $('#minuteSelect');
            const competitionName = $('#competitionName');
            const roundName = $('#roundName');
            const homeTeam = $('#homeTeam');
            const awayTeam = $('#awayTeam');
            const homeTeamId = $('#homeTeamId');
            const awayTeamId = $('#awayTeamId');

            // 연도 (현재 + 3년)
            for (let y = currentYear; y <= currentYear + 3; y++) {
                yearSelect.append(`<option value="${y}">${y}</option>`);
            }

            // 월 (1 ~ 12월)
            for (let m = 1; m <= 12; m++) {
                const paddedMonth = String(m).padStart(2, '0');
                monthSelect.append(`<option value="${paddedMonth}">${paddedMonth}</option>`);
            }

            // 일 (1 ~ 31일)
            for (let d = 1; d <= 31; d++) {
                const paddedDay = String(d).padStart(2, '0');
                daySelect.append(`<option value="${paddedDay}">${paddedDay}</option>`);
            }

            // 시 (00 ~ 23시)
            for (let h = 0; h < 24; h++) {
                const paddedHour = String(h).padStart(2, '0');
                hourSelect.append(`<option value="${paddedHour}">${paddedHour}</option>`);
            }

            // 분 (00 ~ 59분)
            for (let m = 0; m < 60; m++) {
                const paddedMinute = String(m).padStart(2, '0');
                minuteSelect.append(`<option value="${paddedMinute}">${paddedMinute}</option>`);
            }

            // 팀, 어웨이 검색 클릭 시 Modal 열기
            teamValue.on('click', (e) => {
                $('#exampleModal').modal('show');
                modalFromValue.val($(e.currentTarget).parent().data('value'));
            });
            teamSearchButton.on('click', (e) => {
                $('#exampleModal').modal('show');
                modalFromValue.val($(e.currentTarget).parent().data('value'));
            });

            // Modal 안 팀 검색
            teamSearchValue.on('input', (e) => {
                const keyword = $(e.currentTarget).val().trim();

                $('.fandom-item').each(function() {
                    const text = $(this).text();
                    if (text.includes(keyword)) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });

            // 팀 클릭 시 홈, 어웨이 데이터바인딩
            $('.fandom-item').on('click', (e) => {
                const from = modalFromValue.val();
                const value = $(e.currentTarget).text();
                const teamId = $(e.currentTarget).data('value');

                if (from == "home") {
                    homeTeam.val(value);
                    homeTeamId.val(teamId);
                }
                if (from == "away") {
                    awayTeam.val(value);
                    awayTeamId.val(teamId);
                }

                $('#exampleModal').modal('hide');
            });

            // 일정 저장 버튼
            saveScheduleButton.on('click', (e) => {
                const yearValue = parseInt(yearSelect.val());
                const monthValue = parseInt(monthSelect.val()) - 1;
                const hourValue = parseInt(hourSelect.val());
                const dayValue = parseInt(daySelect.val());
                const minuteValue = parseInt(minuteSelect.val());
                const date = new Date(yearValue, monthValue, dayValue, hourValue, minuteValue);
                const isoDate = date.toISOString();

                const schedule = {
                    scheduleDate : isoDate,
                    competitionId : competitionName.val(),
                    roundId : roundName.val(),
                    homeTeamId : homeTeamId.val(),
                    awayTeamId : awayTeamId.val()
                }

                if (schedule.homeTeamId.length == 0) {
                    alert("홈팀을 선택해주세요.");
                    e.preventDefault();
                    return;
                }
                if (schedule.awayTeamId.length == 0) {
                    alert("어웨이팀을 선택해주세요.");
                    e.preventDefault();
                    return;
                }

                $.ajax({
                    url : "/admin/save-schedule",
                    method : "POST",
                    contentType : "application/json",
                    data : JSON.stringify(schedule),
                    dataType : "text",
                    success : (response, status, xhr) => {
                        if (response == "success") alert("일정을 저장하였습니다.");
                    },
                    error : (status, xhr, error) => {
                        alert("일정을 저장하지 못했습니다. 다시 시도해주세요.");
                    }
                });

            });

        });
    </script>
</body>
</html>