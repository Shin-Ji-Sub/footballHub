<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/main.css">
    <link rel="stylesheet" href="/admin.css">
    <title>FootballHub</title>
</head>
<body>
    <div th:replace="~{/admin/modules/header}"></div>
    <input id="socialMethod" type="hidden" th:if="${session.user != null}" th:value="${session.user.socialMethod}">

    <main>
        <div class="main-container">
            <!-- 대회명, 라운드/주차, 팀 INSERT -->
            <div class="container section schedule-container">
                <h4>대회 및 팀 입력</h4>
                <div class="grid-select-container">
                    <div>
                        <h5>대회명</h5>
                        <div class="input-group">
                            <input type="text" class="form-control" id="insertCompetitionValue" placeholder="대회명 (ex: 프리미어리그)">
                            <button class="btn btn-primary" id="insertCompetition" type="button">
                                저장
                            </button>
                        </div>
                    </div>
                    <div>
                        <h5>라운드/주차</h5>
                        <div class="input-group">
                            <input type="text" class="form-control" id="insertRoundValue" placeholder="라운드/주차명 (ex: 16강 1차전, 34R)">
                            <button class="btn btn-primary" id="insertRound" type="button">
                                저장
                            </button>
                        </div>
                    </div>
                </div>
                <div class="dividing-line"></div>
                <div class="grid-select-container">
                    <div>
                        <h5>팀 이름</h5>
                        <input type="text" class="form-control" id="insertTeamValue" placeholder="팀명 (ex: 맨체스터 유나이티드)">
                    </div>
                    <div>
                        <h5>팀 로고</h5>
                        <input type="text" class="form-control" id="insertLogoValue" placeholder="팀 로고 주소 (ex: https://upload.wikimedia.org/wikipedia/en/0/0c/Liverpool_FC.svg)">
                    </div>
                </div>
                <button type="button" class="btn btn-primary schedule-save-button" id="saveTeamButton">저장</button>
            </div>
            <!-- 일정 INSERT -->
            <div class="container section schedule-container">
                <h4>일정 입력</h4>
                <div>
                    <h5>경기 날짜</h5>
                    <div class="date-select-container">
                        <div class="date-select">
                            <select id="yearSelect" class="form-select" aria-label="Default select example"></select>
                            <span>년</span>
                        </div>
                        <div class="date-select">
                            <select id="monthSelect" class="form-select" aria-label="Default select example"></select>
                            <span>월</span>
                        </div>
                        <div class="date-select">
                            <select id="hourSelect" class="form-select" aria-label="Default select example"></select>
                            <span>시</span>
                        </div>
                        <div class="date-select">
                            <select id="minuteSelect" class="form-select" aria-label="Default select example"></select>
                            <span>분</span>
                        </div>
                    </div>
                </div>
                <div class="grid-select-container">
                    <div>
                        <h5>대회명</h5>
                        <select id="competitionName" class="form-select" aria-label="Default select example">
                            <option th:each="comp : ${competitions}"
                                    th:value="${comp.competitionId}"
                                    th:text="${comp.competitionName}"></option>
                        </select>
                    </div>
                    <div>
                        <h5>라운드/주차</h5>
                        <select id="roundName" class="form-select" aria-label="Default select example">
                            <option th:each="round : ${rounds}"
                                    th:value="${round.roundId}"
                                    th:text="${round.roundName}"></option>
                        </select>
                    </div>
                </div>
                <div class="grid-select-container">
                    <div>
                        <h5>홈팀</h5>
                        <div class="input-group" data-value="home">
                            <input type="text" class="form-control team-value" id="homeTeam" placeholder="팀 검색">
                            <button class="btn btn-outline-secondary team-search-button" type="button">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <h5>어웨이팀</h5>
                        <div class="input-group" data-value="away">
                            <input type="text" class="form-control team-value" id="awayTeam" placeholder="팀 검색">
                            <button class="btn btn-outline-secondary team-search-button" type="button">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-primary schedule-save-button" id="saveScheduleButton">저장</button>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">팀 선택</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h2 class="fs-5">팀 검색</h2>
                    <input type="text" class="team-search" id="teamSearchValue">
                    <hr>
                    <h2 class="fs-5">팀 목록</h2>
                    <p class="fandom-item-container">
                        <span class="btn btn-outline-primary fandom-item"
                              th:each="team : ${teams}"
                              th:text="${team.teamName}"></span>
                    </p>
                    <input type="hidden" id="modalFromValue">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script type="text/javascript" th:inline="javascript">
        $(window).on('load', function() {
            // 현재 page nav에 표시
            const locationCategories = $('.location-category');
            locationCategories.eq(3).addClass('active');
            locationCategories.eq(3).addClass('text-primary');

            /* 일정 Section */
            const insertCompetition = $('#insertCompetition');
            const insertRound = $('#insertRound');
            const saveTeamButton = $('#saveTeamButton');

            // 대회명
            insertCompetition.on('click', (e) => {
                const value = $('#insertCompetitionValue').val();
                $.ajax({
                    url : "/admin/save-schedule-category",
                    method : "POST",
                    data : "value=" + value + "&from=competition",
                    dataType : "text",
                    success : (response, status, xhr) => {
                        if (response == "success") {
                            alert("대회명을 저장하였습니다.");
                            $('#insertCompetitionValue').val("");
                        }
                        if (response == "valueEmpty") {
                            alert("대회명을 입력해주세요.");
                            $('#insertCompetitionValue').focus();
                        }
                    },
                    error : (status, xhr, error) => {
                        alert("대회명을 저장하지 못하였습니다. 다시 시도해주세요.");
                    }
                });
            });

            // 라운드/주차
            insertRound.on('click', (e) => {
                const value = $('#insertRoundValue').val();
                $.ajax({
                    url : "/admin/save-schedule-category",
                    method : "POST",
                    data : "value=" + value + "&from=round",
                    dataType : "text",
                    success : (response, status, xhr) => {
                        if (response == "success") {
                            alert("라운드/주차를 저장하였습니다.");
                            $('#insertRoundValue').val("");
                        }
                        if (response == "valueEmpty") {
                            alert("라운드/주차명을 입력해주세요.");
                            $('#insertRoundValue').focus();
                        }
                    },
                    error : (status, xhr, error) => {
                        alert("라운드/주차를 저장하지 못하였습니다. 다시 시도해주세요.");
                    }
                });
            });

            // 팀
            saveTeamButton.on('click', (e) => {
                const value = $('#insertTeamValue').val();
                const logo = $('#insertLogoValue').val();
                $.ajax({
                    url : "/admin/save-schedule-category",
                    method : "POST",
                    data : "value=" + value + "&logo=" + logo + "&from=team",
                    dataType : "text",
                    success : (response, status, xhr) => {
                        if (response == "success") {
                            alert("팀을 저장하였습니다.");
                            $('#insertTeamValue').val("");
                            $('#insertLogoValue').val("");
                        }
                        if (response == "valueEmpty") {
                            alert("팀명을 입력해주세요.");
                            $('#insertTeamValue').focus();
                        }
                        if (response == "logoEmpty") {
                            alert("로고 주소를 입력해주세요.");
                            $('#insertLogoValue').focus();
                        }
                    },
                    error : (status, xhr, error) => {
                        alert("팀을 저장하지 못하였습니다. 다시 시도해주세요.");
                    }
                });
            });


            /* 일정 Section */
            const teamValue = $('.team-value');
            const teamSearchButton = $('.team-search-button');
            const modalFromValue = $('#modalFromValue');
            const teamSearchValue = $('#teamSearchValue');
            const homeTeam = $('#homeTeam');
            const awayTeam = $('#awayTeam');
            const currentYear = new Date().getFullYear();

            // 연도 (현재 + 3년)
            for (let y = currentYear; y <= currentYear + 3; y++) {
                $('#yearSelect').append(`<option value="${y}">${y}</option>`);
            }

            // 월 (1 ~ 12월)
            for (let m = 1; m <= 12; m++) {
                const paddedMonth = String(m).padStart(2, '0');
                $('#monthSelect').append(`<option value="${paddedMonth}">${paddedMonth}</option>`);
            }

            // 시 (00 ~ 23시)
            for (let h = 0; h < 24; h++) {
                const paddedHour = String(h).padStart(2, '0');
                $('#hourSelect').append(`<option value="${paddedHour}">${paddedHour}</option>`);
            }

            // 분 (00 ~ 59분)
            for (let m = 0; m < 60; m++) {
                const paddedMinute = String(m).padStart(2, '0');
                $('#minuteSelect').append(`<option value="${paddedMinute}">${paddedMinute}</option>`);
            }

            // 팀, 어웨이 검색 클릭 시 Modal 열기
            teamValue.on('click', (e) => {
                $('#exampleModal').modal('show');
                modalFromValue.val($(e.currentTarget).parent().data('value'));
            });
            teamSearchButton.on('click', (e) => {
                $('#exampleModal').modal('show');
                modalFromValue.val($(e.currentTarget).parent().data('value'));
            });

            // Modal 안 팀 검색
            teamSearchValue.on('input', (e) => {
                const keyword = $(e.currentTarget).val().trim();

                $('.fandom-item').each(function() {
                    const text = $(this).text();
                    if (text.includes(keyword)) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });

            // 팀 클릭 시 홈, 어웨이 데이터바인딩
            $('.fandom-item').on('click', (e) => {
                const from = modalFromValue.val();
                const value = $(e.currentTarget).text();

                if (from == "home") {
                    homeTeam.val(value);
                }
                if (from == "away") {
                    awayTeam.val(value);
                }

                $('#exampleModal').modal('hide');
            });

        });
    </script>
</body>
</html>